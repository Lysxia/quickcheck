#!/bin/zsh

set -e

module() {
    prefix=${1/\.hs/}
    echo ${prefix//\//.}
}

# Convert modules in quickcheck-light into normal quickcheck
for input in Test/**/*.hs; do
    output=${input/\/Light/}

    (awk '
      !stop { print; }
      !module && /module/ { module=1; }
      module && !stop && /where/ { stop=1; }' \
      $input | sed 's/\.Light//';
     print;
     print -- "-- Autogenerated - please run full/update to regenerate"
     print "import $(module $input)") > full/$output
done

echo 'import Test.QuickCheck.Arbitrary.Instances' >> full/Test/QuickCheck.hs
echo 'import Test.QuickCheck.Arbitrary.Instances' >> full/Test/QuickCheck/Arbitrary.hs
echo 'import Test.QuickCheck.Function.Instances' >> full/Test/QuickCheck/Function.hs

cpp=$(awk '
  /-- END/ { copy=0; }
  copy { print; }
  /-- START/ { copy=1; }' \
  QuickCheck-light.cabal)

echo $cpp | sed 's/\.Light//' |
awk '
  /-- END/ { skip=0; }
  !skip { print; }
  /-- START/ { skip=1; while (getline < "-") print; }' \
  full/QuickCheck.cabal > full/QuickCheck.cabal.tmp

mv full/QuickCheck.cabal.tmp full/QuickCheck.cabal
